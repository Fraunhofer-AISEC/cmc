#!/bin/bash

set -e

trap '[ $? -eq 0 ] && exit 0; printf "[\033[31;1mFAILED\033[0m] %s\n" "$0"' EXIT
dir=$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)

data="${dir}/vm"

# Build binaries
go build -C "${dir}/cmcd"
go build -C "${dir}/cmcctl"
go build -C "${dir}/provision/estserver"
go build -C "${dir}/tools/mrtool"

# Stop running services in VM
vm-ssh systemctl stop cmcd
vm-ssh systemctl stop cmcctl

# Remove cmc internal folder to enforce generation of new certs
vm-ssh rm -rf /var/cmc/internal

# Copy new binaries into VM
vm-scp cmcd/cmcd vm-ubuntu:/usr/bin/
vm-scp cmcctl/cmcctl vm-ubuntu:/usr/bin/
vm-scp tools/mrtool/mrtool vm-ubuntu:/usr/bin/

# Restart services
vm-ssh systemctl start cmcd
vm-ssh systemctl start cmcctl
