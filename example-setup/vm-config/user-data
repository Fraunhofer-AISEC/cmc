#cloud-config
users:
  - name: root
    ssh-authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKEvZTl42rvS0bWVlquka6GdUT+xa6/rydiVTd6GGwal 
    shell: /bin/bash
    lock_passwd: true

chpasswd:
  expire: false
  users:
  - {name: root, password: root, type: text}

disable_root: false

ssh_pwauth: false

apt:
  sources:
    docker:
      keyid: '9DC858229FC7DD38854AE2D88D81803C0EBFCD88'
      keyserver: 'https://download.docker.com/linux/ubuntu/gpg'
      source: 'deb [ signed-by=$KEY_FILE] https://download.docker.com/linux/ubuntu $RELEASE stable'

# will be done anyway since packages and apt source provided
package_update: true

packages:
  - tpm2-tools
  - docker-ce
  - docker-ce-cli
  - containerd.io

# enable ipv4 forwarding for docker
write_files:
  - path: /etc/sysctl.d/enabled_ipv4_forwarding.conf
    content: |
      net.ipv4.conf.all.forwarding=1

runcmd:
  - mount /dev/sr0 /mnt/
  - mkdir /var/cmcctl
  - cp /mnt/cmcd /usr/bin/
  - cp /mnt/cmcctl /usr/bin/
  - cp /mnt/parse-srtm-pcrs /usr/bin/
  - cp /mnt/parse-ima-pcr /usr/bin/
  - cp /mnt/cmcd-conf.json /etc/cmcd-conf.json
  - cp /mnt/cmcctl-conf-vm.json /etc/cmcctl-conf-vm.json
  - cp /mnt/cmcd.service /etc/systemd/system/cmcd.service
  - cp /mnt/cmcctl.service /etc/systemd/system/cmcctl.service
  - cp /mnt/ca.pem /var/ca.pem
  - cp /mnt/metadata-ca.pem /var/metadata-ca.pem
  - systemctl daemon-reload
  - systemctl enable cmcd.service
  - systemctl start cmcd.service
  - systemctl enable cmcctl.service
  - systemctl start cmcctl.service


