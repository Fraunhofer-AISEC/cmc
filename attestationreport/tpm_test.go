// Copyright (c) 2021 Fraunhofer AISEC
// Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package attestationreport

import (
	"encoding/hex"
	"math/big"
	"reflect"
	"testing"

	"github.com/sirupsen/logrus"
)

func Test_verifyTpmMeasurements(t *testing.T) {
	type args struct {
		tpmM            *TpmMeasurement
		nonce           []byte
		referenceValues []ReferenceValue
		casPem          []byte
	}
	tests := []struct {
		name  string
		args  args
		want  *TpmMeasurementResult
		want1 bool
	}{
		{
			name: "Valid TPM Measurement",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: validSignature,
					Certs:     validTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(validCa),
			},
			want:  &validTpmMeasurementResult,
			want1: true,
		},
		{
			name: "Invalid Nonce",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: validSignature,
					Certs:     validTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           invalidTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(validCa),
			},
			want:  nil,
			want1: false,
		},
		{
			name: "Invalid Signature",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: invalidSignature,
					Certs:     validTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(validCa),
			},
			want:  nil,
			want1: false,
		},
		{
			name: "Invalid HashChain",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: invalidSignature,
					Certs:     validTpmCertChain,
					HashChain: invalidHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(validCa),
			},
			want:  nil,
			want1: false,
		},
		{
			name: "Invalid Reference Values",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: invalidSignature,
					Certs:     validTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: invalidReferenceValues,
				casPem:          []byte(validCa),
			},
			want:  nil,
			want1: false,
		},
		{
			name: "Invalid CA SubjectKeyId",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: validSignature,
					Certs:     validTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(invalidCaTpm),
			},
			want:  nil,
			want1: false,
		},
		{
			name: "Invalid Cert Chain",
			args: args{
				tpmM: &TpmMeasurement{
					Type:      "TPM Measurement",
					Message:   validQuote,
					Signature: validSignature,
					Certs:     invalidTpmCertChain,
					HashChain: validHashChain,
				},
				nonce:           validTpmNonce,
				referenceValues: validReferenceValues,
				casPem:          []byte(invalidCaTpm),
			},
			want:  nil,
			want1: false,
		},
	}

	logrus.SetLevel(logrus.InfoLevel)

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, got1 := verifyTpmMeasurements(tt.args.tpmM, tt.args.nonce, tt.args.referenceValues, tt.args.casPem)
			if got1 != tt.want1 {
				t.Errorf("verifyTpmMeasurements() --GOT1-- = %v, --WANT1-- %v", got1, tt.want1)
			}
			if tt.want != nil && !reflect.DeepEqual(got, tt.want) {
				t.Errorf("verifyTpmMeasurements() \n---GOT = %v\n--WANT = %v", got, tt.want)
			}
		})
	}
}

func dec(s string) []byte {
	b, err := hex.DecodeString(s)
	if err != nil {
		log.Fatalf("Failed to decode: %v", err)
	}
	return b
}

var (
	validQuote, _ = hex.DecodeString("ff54434780180022000b518b2cf29ba4f1c5ae463aec4159a9b7e7d6ec3b7632eac14119b73d3bb39e930008db6c3c042fa12645000000004c1efc09d977f45ed5c84b9501262219245c49af3000000001000b03120000002083a306865290be1f8912c44dc520f1b9271b9ecd23b2bbf3a41c9586c69464b2")

	validSignature, _ = hex.DecodeString("0014000b0100b03c414fd7ae091f3c0b1bf2917f4e947ce951f36f00107c5ea088c30a4bc20164a9e2a1671209863299b5df0649a93cb50c76b01365f2bdfd8299c4118dd48d7952c9f92957dd3cd78f5935972aa478099a725d57f2ce42e600e0c2cfd537cd8fa708a82c4deaf02959a1fb0a998c8018f598db51217affb8e37a45ae0d07b0ea9e68d8ec5fbb9f9027105ba2bccd0e33decc30cbf8335065efeb124c5c0869fbed3e45378ac580a2ce099470d893685263339291a586fefff0ccee2b811e627509e027d4eb697d490d7d55819dd8233e35d404762f274c0eea8b057e79148aac79834984d47926acb57c1e8e0c1a404d113c7fe39e0a7d6a49ec90e8d07378")

	invalidSignature, _ = hex.DecodeString("0014000b0100740e077a77ff6ac21754d036f751f5f8ec5ec59448aab05bb5fd2b5d81df58bde3550d855ecf16cd25e36b5688122cfaac1a86ab94954b81d49a1b7fc7648ad26b8b808ce846fe7fd49355d2461d049904e97aa687749d55510f09b7c8610b95b6d557ebdaa25a19bfa1663f236419a1a8d974dd05b14de7f28fbce0a54c3ac428a9cf7f0752cc290580ff8d63e33050c0f53582ae24fe4d30792da71d5ef93581e3371147ed4732a0c0c0461489b1b64b1f28dd5153dbc674f04a21e279833433eabec1642cd386fdca6e52b583b2c914ebcd3c7a334214dc5e7c02880b033e321cb261ed6044785e70599d269511f83a20ee45034f0803d623763d461ce763")

	validHashChain = []*HashChainElem{
		{
			Type:   "Hash Chain",
			Pcr:    1,
			Sha256: []HexByte{dec("5f96aec0a6b390185495c35bc76dceb9fa6addb4e59b6fc1b3e1992eeb08a5c6")},
		},
		{
			Type:   "Hash Chain",
			Pcr:    4,
			Sha256: []HexByte{dec("d3f67dbed9bce9d391a3567edad08971339e4dbabadd5b7eaf082860296e5e72")},
		},
	}

	invalidHashChain = []*HashChainElem{
		{
			Type:   "Hash Chain",
			Pcr:    1,
			Sha256: []HexByte{dec("2a814d03d22568e2d669595dd8be199fd7b3df2acb8caae38e24e92605e15c80")},
		},
		{
			Type:   "Hash Chain",
			Pcr:    4,
			Sha256: []HexByte{dec("1fe8f1a49cf178748a6f6167473bca3cf882ff70b4b4e458e2421c871c9c5bb9")},
		},
	}

	validTpmNonce = []byte{0xdb, 0x6c, 0x3c, 0x04, 0x2f, 0xa1, 0x26, 0x45}

	invalidTpmNonce = []byte{0x6d, 0xb4, 0x8f, 0x3e, 0x33, 0xc9, 0x79, 0x2a}

	validAk = []byte("-----BEGIN CERTIFICATE-----\nMIIDGjCCAr+gAwIBAgIBATAKBggqhkjOPQQDAjBhMQswCQYDVQQGEwJERTESMBAG\nA1UEBxMJVGVzdCBDaXR5MRUwEwYDVQQKEwxUZXN0IENvbXBhbnkxEDAOBgNVBAsT\nB1Jvb3QgQ0ExFTATBgNVBAMTDFRlc3QgUm9vdCBDQTAeFw0yMjExMDcwODUxNDla\nFw0yNzEwMTIwODUxNDlaMIGdMQswCQYDVQQGEwJERTELMAkGA1UECBMCQlkxDzAN\nBgNVBAcTBk11bmljaDEWMBQGA1UECRMNdGVzdHN0cmVldCAxNTEOMAwGA1UEERMF\nODU3NDgxGjAYBgNVBAoTEVRlc3QgT3JnYW5pemF0aW9uMQ8wDQYDVQQLEwZkZXZp\nY2UxGzAZBgNVBAMTEmRlLnRlc3QuYWsuZGV2aWNlMDCCASIwDQYJKoZIhvcNAQEB\nBQADggEPADCCAQoCggEBALMxAElQ+xiBcNrfpPNd6ksmoftvdIAwBHaXJXta0JcN\n28aveILx2gWuAlhpB90h0IngWpETUckxmAJ/KvTtsOH1lhRQeWwXLmFciXc2lKD3\nNk//dtp6LVd7WaJzx8MtNMlsrYgG9tpjGggISTQyFACQYnmapbqvf8OS0UP93vUT\neAnCKBRDAOKT3FjpUl6y66buAnU1u1I9N7XBUem6nQSlw9KymrgXSG0Hvbpe7f6c\nWmNJC2dJOdxxpN523Fq9I9iMIOi+K2DXfsw2ShxtIj0NEWx+/gKNhsdVln5EnYar\nSef7N12tHTSZnl6oTWtnTGMaSmOfa1bkEpXguM9xV9cCAwEAAaNgMF4wDgYDVR0P\nAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFNKgV/REoVQpy8eJ/cOR\nXsE58bLRMB8GA1UdIwQYMBaAFD+Fycu3JAX3sNTSRMvABDRDeOICMAoGCCqGSM49\nBAMCA0kAMEYCIQDIC7CTHr1RYwUIvmd+lfZme2g1lUmuLWlWRzpEhP1K5AIhAMnp\nFhf+1eNqcZkg2ISsZ5GefN/A/5xvbQXPj06hHwZq\n-----END CERTIFICATE-----")

	validCa = []byte("-----BEGIN CERTIFICATE-----\nMIICBjCCAaygAwIBAgIUbzIW+iUiIFmCWbOL4rW4UBQfj7AwCgYIKoZIzj0EAwIw\nYTELMAkGA1UEBhMCREUxEjAQBgNVBAcTCVRlc3QgQ2l0eTEVMBMGA1UEChMMVGVz\ndCBDb21wYW55MRAwDgYDVQQLEwdSb290IENBMRUwEwYDVQQDEwxUZXN0IFJvb3Qg\nQ0EwHhcNMjIxMDIzMTcwMTAwWhcNMjcxMDIyMTcwMTAwWjBhMQswCQYDVQQGEwJE\nRTESMBAGA1UEBxMJVGVzdCBDaXR5MRUwEwYDVQQKEwxUZXN0IENvbXBhbnkxEDAO\nBgNVBAsTB1Jvb3QgQ0ExFTATBgNVBAMTDFRlc3QgUm9vdCBDQTBZMBMGByqGSM49\nAgEGCCqGSM49AwEHA0IABEqaNo91iTSSbc9BL1iIQIVpZLd88RL5LfH15SVugJy4\n3d0jeE+KHtpQA8FpAvxXQHJm31z5V6+oLG4MQfVHN/GjQjBAMA4GA1UdDwEB/wQE\nAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBQ/hcnLtyQF97DU0kTLwAQ0\nQ3jiAjAKBggqhkjOPQQDAgNIADBFAiAFsmaZDBu+cfOqX9a5YAOgSeYB4Sb+r18m\nBIcuxwthhgIhALRHfA32ZcOA6piTKtWLZsdsG6CH50KGImHlkj4TwfXw\n-----END CERTIFICATE-----")

	invalidCaTpm = []byte("-----BEGIN CERTIFICATE-----\nMIICSDCCAc2gAwIBAgIUHxAyr1Y3QlrYutGU317Uy5FhdpQwCgYIKoZIzj0EAwMw\nYzELMAkGA1UEBhMCREUxETAPBgNVBAcTCEdhcmNoaW5nMRkwFwYDVQQKExBGcmF1\nbmhvZmVyIEFJU0VDMRAwDgYDVQQLEwdSb290IENBMRQwEgYDVQQDEwtJRFMgUm9v\ndCBDQTAeFw0yMjA0MDQxNTE3MDBaFw0yNzA0MDMxNTE3MDBaMGMxCzAJBgNVBAYT\nAkRFMREwDwYDVQQHEwhHYXJjaGluZzEZMBcGA1UEChMQRnJhdW5ob2ZlciBBSVNF\nQzEQMA4GA1UECxMHUm9vdCBDQTEUMBIGA1UEAxMLSURTIFJvb3QgQ0EwdjAQBgcq\nhkjOPQIBBgUrgQQAIgNiAAQSneAVxZRShdfwEu3HtCcwRnV5b4UtOnxJaVZ/bILS\n4dThZVWpXNm+ikvp6Sk0RlI30mKl2X7fX8aRew+HvvFT08xJw9dGAkm2Fsp+4/c7\nM3rMhiHXyCpu/Xg4OlxAYOajQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E\nBTADAQH/MB0GA1UdDgQWBBTyFTqqlt0/YxJBiCB3WM7lkpqWVjAKBggqhkjOPQQD\nAwNpADBmAjEAizrjlmYQmrMbsEaGaFzouMT02iMu0NLILhm1wkfAl3UUWymcliy8\nf1IAI1nO4448AjEAkd74w4WEaTqvslmkPktxNhDA1cVL55LDLbUNXLcSdzr2UBhp\nK8Vv1j4nATtg1Vkf\n-----END CERTIFICATE-----\n")

	validTpmCertChain   = [][]byte{validAk, validCa}
	invalidTpmCertChain = [][]byte{validAk, invalidCaTpm}

	pcrs = [23]int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22}

	validReferenceValues = []ReferenceValue{
		{
			Type:   "TPM Reference Value",
			Sha256: dec("ef5631c7bbb8d98ad220e211933fcde16aac6154cf229fea3c728fb0f2c27e39"),
			Name:   "EV_CPU_MICROCODE",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("131462b45df65ac00834c7e73356c246037456959674acd24b08357690a03845"),
			Name:   "Unknown Event Type",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("8574d91b49f1c9a6ecc8b1e8565bd668f819ea8ed73c5f682948141587aecd3b"),
			Name:   "EV_NONHOST_CONFIG",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("afffbd73d1e4e658d5a1768f6fa11a6c38a1b5c94694015bc96418a7b5291b39"),
			Name:   "EV_EFI_VARIABLE_BOOT",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("6cf2851f19f1c3ec3070f20400892cb8e6ee712422efd77d655e2ebde4e00d69"),
			Name:   "EV_EFI_VARIABLE_BOOT",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("faf98c184d571dd4e928f55bbf3b2a6e0fc60ba1fb393a9552f004f76ecf06a7"),
			Name:   "EV_EFI_VARIABLE_BOOT",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("b785d921b9516221dff929db343c124a832cceee1b508b36b7eb37dc50fc18d8"),
			Name:   "EV_EFI_VARIABLE_BOOT",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("df3f619804a92fdb4057192dc43dd748ea778adc52bc498ce80524c014b81119"),
			Name:   "EV_SEPARATOR",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("b997bc194a4b65980eb0cb172bd5cc51a6460b79c047a92e8f4ff9f85d578bd4"),
			Name:   "EV_PLATFORM_CONFIG_FLAGS",
			Pcr:    &pcrs[1],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("3d6772b4f84ed47595d72a2c4c5ffd15f5bb72c7507fe26f2aaee2c69d5633ba"),
			Name:   "EV_EFI_ACTION",
			Pcr:    &pcrs[4],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("df3f619804a92fdb4057192dc43dd748ea778adc52bc498ce80524c014b81119"),
			Name:   "EV_SEPARATOR",
			Pcr:    &pcrs[4],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("dbffd70a2c43fd2c1931f18b8f8c08c5181db15f996f747dfed34def52fad036"),
			Name:   "EV_EFI_BOOT_SERVICES_APPLICATION",
			Pcr:    &pcrs[4],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("acc00aad4b0413a8b349b4493f95830da6a7a44bd6fc1579f6f53c339c26cb05"),
			Name:   "EV_EFI_BOOT_SERVICES_APPLICATION",
			Pcr:    &pcrs[4],
		},
		{
			Type:   "TPM Reference Value",
			Sha256: dec("3ba11d87f4450f0b92bd53676d88a3622220a7d53f0338bf387badc31cf3c025"),
			Name:   "EV_EFI_BOOT_SERVICES_APPLICATION",
			Pcr:    &pcrs[4],
		},
	}

	invalidReferenceValues = []ReferenceValue{
		{
			Type:   "TPM Reference Value",
			Sha256: dec("1310b2b63dc1222516e5c12cedc1cc48e338f85430849b5a5b5256467e2cd0f0"),
			Name:   "SINIT ACM Digest",
			Pcr:    &pcrs[4],
		},
	}

	validResult = Result{
		Success: true,
	}

	validResultMulti = ResultMulti{
		Success: true,
	}

	deviceCertserial, _ = new(big.Int).SetString("1", 10)
	caCertserial, _     = new(big.Int).SetString("634815014411613577372985193537194269253199433648", 10)

	validSignatureResult = SignatureResult{
		ValidatedCerts: [][]x509CertExtracted{
			{
				{
					Raw:          []byte{0x30, 0x82, 0x3, 0x1a, 0x30, 0x82, 0x2, 0xbf, 0xa0, 0x3, 0x2, 0x1, 0x2, 0x2, 0x1, 0x1, 0x30, 0xa, 0x6, 0x8, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x4, 0x3, 0x2, 0x30, 0x61, 0x31, 0xb, 0x30, 0x9, 0x6, 0x3, 0x55, 0x4, 0x6, 0x13, 0x2, 0x44, 0x45, 0x31, 0x12, 0x30, 0x10, 0x6, 0x3, 0x55, 0x4, 0x7, 0x13, 0x9, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x69, 0x74, 0x79, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0xa, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x61, 0x6e, 0x79, 0x31, 0x10, 0x30, 0xe, 0x6, 0x3, 0x55, 0x4, 0xb, 0x13, 0x7, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0x3, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x30, 0x1e, 0x17, 0xd, 0x32, 0x32, 0x31, 0x31, 0x30, 0x37, 0x30, 0x38, 0x35, 0x31, 0x34, 0x39, 0x5a, 0x17, 0xd, 0x32, 0x37, 0x31, 0x30, 0x31, 0x32, 0x30, 0x38, 0x35, 0x31, 0x34, 0x39, 0x5a, 0x30, 0x81, 0x9d, 0x31, 0xb, 0x30, 0x9, 0x6, 0x3, 0x55, 0x4, 0x6, 0x13, 0x2, 0x44, 0x45, 0x31, 0xb, 0x30, 0x9, 0x6, 0x3, 0x55, 0x4, 0x8, 0x13, 0x2, 0x42, 0x59, 0x31, 0xf, 0x30, 0xd, 0x6, 0x3, 0x55, 0x4, 0x7, 0x13, 0x6, 0x4d, 0x75, 0x6e, 0x69, 0x63, 0x68, 0x31, 0x16, 0x30, 0x14, 0x6, 0x3, 0x55, 0x4, 0x9, 0x13, 0xd, 0x74, 0x65, 0x73, 0x74, 0x73, 0x74, 0x72, 0x65, 0x65, 0x74, 0x20, 0x31, 0x35, 0x31, 0xe, 0x30, 0xc, 0x6, 0x3, 0x55, 0x4, 0x11, 0x13, 0x5, 0x38, 0x35, 0x37, 0x34, 0x38, 0x31, 0x1a, 0x30, 0x18, 0x6, 0x3, 0x55, 0x4, 0xa, 0x13, 0x11, 0x54, 0x65, 0x73, 0x74, 0x20, 0x4f, 0x72, 0x67, 0x61, 0x6e, 0x69, 0x7a, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x31, 0xf, 0x30, 0xd, 0x6, 0x3, 0x55, 0x4, 0xb, 0x13, 0x6, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x31, 0x1b, 0x30, 0x19, 0x6, 0x3, 0x55, 0x4, 0x3, 0x13, 0x12, 0x64, 0x65, 0x2e, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x61, 0x6b, 0x2e, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x30, 0x30, 0x82, 0x1, 0x22, 0x30, 0xd, 0x6, 0x9, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0xd, 0x1, 0x1, 0x1, 0x5, 0x0, 0x3, 0x82, 0x1, 0xf, 0x0, 0x30, 0x82, 0x1, 0xa, 0x2, 0x82, 0x1, 0x1, 0x0, 0xb3, 0x31, 0x0, 0x49, 0x50, 0xfb, 0x18, 0x81, 0x70, 0xda, 0xdf, 0xa4, 0xf3, 0x5d, 0xea, 0x4b, 0x26, 0xa1, 0xfb, 0x6f, 0x74, 0x80, 0x30, 0x4, 0x76, 0x97, 0x25, 0x7b, 0x5a, 0xd0, 0x97, 0xd, 0xdb, 0xc6, 0xaf, 0x78, 0x82, 0xf1, 0xda, 0x5, 0xae, 0x2, 0x58, 0x69, 0x7, 0xdd, 0x21, 0xd0, 0x89, 0xe0, 0x5a, 0x91, 0x13, 0x51, 0xc9, 0x31, 0x98, 0x2, 0x7f, 0x2a, 0xf4, 0xed, 0xb0, 0xe1, 0xf5, 0x96, 0x14, 0x50, 0x79, 0x6c, 0x17, 0x2e, 0x61, 0x5c, 0x89, 0x77, 0x36, 0x94, 0xa0, 0xf7, 0x36, 0x4f, 0xff, 0x76, 0xda, 0x7a, 0x2d, 0x57, 0x7b, 0x59, 0xa2, 0x73, 0xc7, 0xc3, 0x2d, 0x34, 0xc9, 0x6c, 0xad, 0x88, 0x6, 0xf6, 0xda, 0x63, 0x1a, 0x8, 0x8, 0x49, 0x34, 0x32, 0x14, 0x0, 0x90, 0x62, 0x79, 0x9a, 0xa5, 0xba, 0xaf, 0x7f, 0xc3, 0x92, 0xd1, 0x43, 0xfd, 0xde, 0xf5, 0x13, 0x78, 0x9, 0xc2, 0x28, 0x14, 0x43, 0x0, 0xe2, 0x93, 0xdc, 0x58, 0xe9, 0x52, 0x5e, 0xb2, 0xeb, 0xa6, 0xee, 0x2, 0x75, 0x35, 0xbb, 0x52, 0x3d, 0x37, 0xb5, 0xc1, 0x51, 0xe9, 0xba, 0x9d, 0x4, 0xa5, 0xc3, 0xd2, 0xb2, 0x9a, 0xb8, 0x17, 0x48, 0x6d, 0x7, 0xbd, 0xba, 0x5e, 0xed, 0xfe, 0x9c, 0x5a, 0x63, 0x49, 0xb, 0x67, 0x49, 0x39, 0xdc, 0x71, 0xa4, 0xde, 0x76, 0xdc, 0x5a, 0xbd, 0x23, 0xd8, 0x8c, 0x20, 0xe8, 0xbe, 0x2b, 0x60, 0xd7, 0x7e, 0xcc, 0x36, 0x4a, 0x1c, 0x6d, 0x22, 0x3d, 0xd, 0x11, 0x6c, 0x7e, 0xfe, 0x2, 0x8d, 0x86, 0xc7, 0x55, 0x96, 0x7e, 0x44, 0x9d, 0x86, 0xab, 0x49, 0xe7, 0xfb, 0x37, 0x5d, 0xad, 0x1d, 0x34, 0x99, 0x9e, 0x5e, 0xa8, 0x4d, 0x6b, 0x67, 0x4c, 0x63, 0x1a, 0x4a, 0x63, 0x9f, 0x6b, 0x56, 0xe4, 0x12, 0x95, 0xe0, 0xb8, 0xcf, 0x71, 0x57, 0xd7, 0x2, 0x3, 0x1, 0x0, 0x1, 0xa3, 0x60, 0x30, 0x5e, 0x30, 0xe, 0x6, 0x3, 0x55, 0x1d, 0xf, 0x1, 0x1, 0xff, 0x4, 0x4, 0x3, 0x2, 0x7, 0x80, 0x30, 0xc, 0x6, 0x3, 0x55, 0x1d, 0x13, 0x1, 0x1, 0xff, 0x4, 0x2, 0x30, 0x0, 0x30, 0x1d, 0x6, 0x3, 0x55, 0x1d, 0xe, 0x4, 0x16, 0x4, 0x14, 0xd2, 0xa0, 0x57, 0xf4, 0x44, 0xa1, 0x54, 0x29, 0xcb, 0xc7, 0x89, 0xfd, 0xc3, 0x91, 0x5e, 0xc1, 0x39, 0xf1, 0xb2, 0xd1, 0x30, 0x1f, 0x6, 0x3, 0x55, 0x1d, 0x23, 0x4, 0x18, 0x30, 0x16, 0x80, 0x14, 0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x5, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x4, 0x34, 0x43, 0x78, 0xe2, 0x2, 0x30, 0xa, 0x6, 0x8, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x4, 0x3, 0x2, 0x3, 0x49, 0x0, 0x30, 0x46, 0x2, 0x21, 0x0, 0xc8, 0xb, 0xb0, 0x93, 0x1e, 0xbd, 0x51, 0x63, 0x5, 0x8, 0xbe, 0x67, 0x7e, 0x95, 0xf6, 0x66, 0x7b, 0x68, 0x35, 0x95, 0x49, 0xae, 0x2d, 0x69, 0x56, 0x47, 0x3a, 0x44, 0x84, 0xfd, 0x4a, 0xe4, 0x2, 0x21, 0x0, 0xc9, 0xe9, 0x16, 0x17, 0xfe, 0xd5, 0xe3, 0x6a, 0x71, 0x99, 0x20, 0xd8, 0x84, 0xac, 0x67, 0x91, 0x9e, 0x7c, 0xdf, 0xc0, 0xff, 0x9c, 0x6f, 0x6d, 0x5, 0xcf, 0x8f, 0x4e, 0xa1, 0x1f, 0x6, 0x6a},
					Version:      3,
					SerialNumber: deviceCertserial,
					Issuer: x509Name{
						Country:            []string{"DE"},
						Organization:       []string{"Test Company"},
						OrganizationalUnit: []string{"Root CA"},
						Locality:           []string{"Test City"},
						CommonName:         "Test Root CA",
					},
					Subject: x509Name{
						Country:            []string{"DE"},
						Organization:       []string{"Test Organization"},
						OrganizationalUnit: []string{"device"},
						Locality:           []string{"Munich"},
						Province:           []string{"BY"},
						StreetAddress:      []string{"teststreet 15"},
						PostalCode:         []string{"85748"},
						CommonName:         "de.test.ak.device0",
					},
					Validity: Validity{
						NotBefore: "2022-11-07 08:51:49 +0000 UTC",
						NotAfter:  "2027-10-12 08:51:49 +0000 UTC",
					},
					KeyUsage:           []string{"Digital Signature"},
					SignatureAlgorithm: "ECDSA-SHA256",
					PublicKeyAlgorithm: "RSA",
					Extensions: []PkixExtension{
						{
							Id:       "2.5.29.15",
							Critical: true,
							Value:    []byte{0x03, 0x02, 0x07, 0x80},
						},
						{
							Id:       "2.5.29.19",
							Critical: true,
							Value:    []byte{0x30, 0x00},
						},
						{
							Id:       "2.5.29.14",
							Critical: false,
							Value:    []byte{0x04, 0x14, 0xd2, 0xa0, 0x57, 0xf4, 0x44, 0xa1, 0x54, 0x29, 0xcb, 0xc7, 0x89, 0xfd, 0xc3, 0x91, 0x5e, 0xc1, 0x39, 0xf1, 0xb2, 0xd1},
						},
						{
							Id:       "2.5.29.35",
							Critical: false,
							Value:    []byte{0x30, 0x16, 0x80, 0x14, 0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x05, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x04, 0x34, 0x43, 0x78, 0xe2, 0x02},
						},
					},
					ExtKeyUsage:           []string{},
					BasicConstraintsValid: true,
					MaxPathLen:            -1,
					SubjectKeyId:          []byte{0xd2, 0xa0, 0x57, 0xf4, 0x44, 0xa1, 0x54, 0x29, 0xcb, 0xc7, 0x89, 0xfd, 0xc3, 0x91, 0x5e, 0xc1, 0x39, 0xf1, 0xb2, 0xd1},
					AuthorityKeyId:        []byte{0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x5, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x4, 0x34, 0x43, 0x78, 0xe2, 0x02},
				},
				{
					Raw:          []byte{0x30, 0x82, 0x2, 0x6, 0x30, 0x82, 0x1, 0xac, 0xa0, 0x3, 0x2, 0x1, 0x2, 0x2, 0x14, 0x6f, 0x32, 0x16, 0xfa, 0x25, 0x22, 0x20, 0x59, 0x82, 0x59, 0xb3, 0x8b, 0xe2, 0xb5, 0xb8, 0x50, 0x14, 0x1f, 0x8f, 0xb0, 0x30, 0xa, 0x6, 0x8, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x4, 0x3, 0x2, 0x30, 0x61, 0x31, 0xb, 0x30, 0x9, 0x6, 0x3, 0x55, 0x4, 0x6, 0x13, 0x2, 0x44, 0x45, 0x31, 0x12, 0x30, 0x10, 0x6, 0x3, 0x55, 0x4, 0x7, 0x13, 0x9, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x69, 0x74, 0x79, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0xa, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x61, 0x6e, 0x79, 0x31, 0x10, 0x30, 0xe, 0x6, 0x3, 0x55, 0x4, 0xb, 0x13, 0x7, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0x3, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x30, 0x1e, 0x17, 0xd, 0x32, 0x32, 0x31, 0x30, 0x32, 0x33, 0x31, 0x37, 0x30, 0x31, 0x30, 0x30, 0x5a, 0x17, 0xd, 0x32, 0x37, 0x31, 0x30, 0x32, 0x32, 0x31, 0x37, 0x30, 0x31, 0x30, 0x30, 0x5a, 0x30, 0x61, 0x31, 0xb, 0x30, 0x9, 0x6, 0x3, 0x55, 0x4, 0x6, 0x13, 0x2, 0x44, 0x45, 0x31, 0x12, 0x30, 0x10, 0x6, 0x3, 0x55, 0x4, 0x7, 0x13, 0x9, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x69, 0x74, 0x79, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0xa, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x61, 0x6e, 0x79, 0x31, 0x10, 0x30, 0xe, 0x6, 0x3, 0x55, 0x4, 0xb, 0x13, 0x7, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x31, 0x15, 0x30, 0x13, 0x6, 0x3, 0x55, 0x4, 0x3, 0x13, 0xc, 0x54, 0x65, 0x73, 0x74, 0x20, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x43, 0x41, 0x30, 0x59, 0x30, 0x13, 0x6, 0x7, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x2, 0x1, 0x6, 0x8, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x3, 0x1, 0x7, 0x3, 0x42, 0x0, 0x4, 0x4a, 0x9a, 0x36, 0x8f, 0x75, 0x89, 0x34, 0x92, 0x6d, 0xcf, 0x41, 0x2f, 0x58, 0x88, 0x40, 0x85, 0x69, 0x64, 0xb7, 0x7c, 0xf1, 0x12, 0xf9, 0x2d, 0xf1, 0xf5, 0xe5, 0x25, 0x6e, 0x80, 0x9c, 0xb8, 0xdd, 0xdd, 0x23, 0x78, 0x4f, 0x8a, 0x1e, 0xda, 0x50, 0x3, 0xc1, 0x69, 0x2, 0xfc, 0x57, 0x40, 0x72, 0x66, 0xdf, 0x5c, 0xf9, 0x57, 0xaf, 0xa8, 0x2c, 0x6e, 0xc, 0x41, 0xf5, 0x47, 0x37, 0xf1, 0xa3, 0x42, 0x30, 0x40, 0x30, 0xe, 0x6, 0x3, 0x55, 0x1d, 0xf, 0x1, 0x1, 0xff, 0x4, 0x4, 0x3, 0x2, 0x1, 0x6, 0x30, 0xf, 0x6, 0x3, 0x55, 0x1d, 0x13, 0x1, 0x1, 0xff, 0x4, 0x5, 0x30, 0x3, 0x1, 0x1, 0xff, 0x30, 0x1d, 0x6, 0x3, 0x55, 0x1d, 0xe, 0x4, 0x16, 0x4, 0x14, 0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x5, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x4, 0x34, 0x43, 0x78, 0xe2, 0x2, 0x30, 0xa, 0x6, 0x8, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x4, 0x3, 0x2, 0x3, 0x48, 0x0, 0x30, 0x45, 0x2, 0x20, 0x5, 0xb2, 0x66, 0x99, 0xc, 0x1b, 0xbe, 0x71, 0xf3, 0xaa, 0x5f, 0xd6, 0xb9, 0x60, 0x3, 0xa0, 0x49, 0xe6, 0x1, 0xe1, 0x26, 0xfe, 0xaf, 0x5f, 0x26, 0x4, 0x87, 0x2e, 0xc7, 0xb, 0x61, 0x86, 0x2, 0x21, 0x0, 0xb4, 0x47, 0x7c, 0xd, 0xf6, 0x65, 0xc3, 0x80, 0xea, 0x98, 0x93, 0x2a, 0xd5, 0x8b, 0x66, 0xc7, 0x6c, 0x1b, 0xa0, 0x87, 0xe7, 0x42, 0x86, 0x22, 0x61, 0xe5, 0x92, 0x3e, 0x13, 0xc1, 0xf5, 0xf0},
					Version:      3,
					SerialNumber: caCertserial,
					Issuer: x509Name{
						Country:            []string{"DE"},
						Organization:       []string{"Test Company"},
						OrganizationalUnit: []string{"Root CA"},
						Locality:           []string{"Test City"},
						CommonName:         "Test Root CA",
					},
					Subject: x509Name{
						Country:            []string{"DE"},
						Organization:       []string{"Test Company"},
						OrganizationalUnit: []string{"Root CA"},
						Locality:           []string{"Test City"},
						CommonName:         "Test Root CA",
					},
					Validity: Validity{
						NotBefore: "2022-10-23 17:01:00 +0000 UTC",
						NotAfter:  "2027-10-22 17:01:00 +0000 UTC",
					},
					KeyUsage:           []string{"Cert Sign", "CRL Sign"},
					SignatureAlgorithm: "ECDSA-SHA256",
					PublicKeyAlgorithm: "ECDSA",
					Extensions: []PkixExtension{
						{
							Id:       "2.5.29.15",
							Critical: true,
							Value:    []byte{0x03, 0x02, 0x01, 0x06},
						},
						{
							Id:       "2.5.29.19",
							Critical: true,
							Value:    []byte{0x30, 0x03, 0x01, 0x01, 0xff},
						},
						{
							Id:       "2.5.29.14",
							Critical: false,
							Value:    []byte{0x04, 0x14, 0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x05, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x04, 0x34, 0x43, 0x78, 0xe2, 0x02},
						},
					},
					ExtKeyUsage:           []string{},
					BasicConstraintsValid: true,
					IsCA:                  true,
					MaxPathLen:            -1,
					SubjectKeyId:          []byte{0x3f, 0x85, 0xc9, 0xcb, 0xb7, 0x24, 0x5, 0xf7, 0xb0, 0xd4, 0xd2, 0x44, 0xcb, 0xc0, 0x4, 0x34, 0x43, 0x78, 0xe2, 0x02},
					AuthorityKeyId:        nil,
				},
			},
		},
		SignCheck:       validResult,
		CertChainCheck:  validResult,
		RoleCheck:       nil,
		ExtensionsCheck: nil,
	}

	validTpmMeasurementResult = TpmMeasurementResult{
		Summary: validResult,
		PcrRecalculation: []PcrResult{
			{
				Pcr:        1,
				Validation: validResultMulti,
			},
			{
				Pcr:        4,
				Validation: validResultMulti,
			},
		},
		AggPcrQuoteMatch:    validResult,
		QuoteFreshness:      validResult,
		QuoteSignature:      validSignatureResult,
		ReferenceValueCheck: validResultMulti,
	}
)
