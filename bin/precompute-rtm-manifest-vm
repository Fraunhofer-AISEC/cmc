#!/bin/bash

set -euo pipefail

trap '[ $? -eq 0 ] && exit 0; printf "%s failed\n" "$0"' EXIT
dir="$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)"
source "${dir}/bin/utils.sh"

data="${dir}/data"
input="${dir}/example-setup/metadata-templates"
out="${data}/metadata-raw"

images="${dir}/vm/images"
vm_config="${dir}/example-setup/vm-config"
artifacts="${dir}/vm/artifacts"

image_description="${out}/image.description.json"

if [[ ! -d "${data}" ]]; then
  echo "Data directory ${1} does not exist. Did you run the setup-cmc script? Abort.."
  exit 1
fi

if [[ ! -d "${input}" ]]; then
  echo "Data directory ${input} does not exist. Did you run the setup-cmc script? Abort.."
  exit 1
fi

mkdir -p "${out}"

echo "Using ${data} as directory for local data"

# Retrieve platform details
set +e
firmware="OVMF"
bootloader="GRUB"
set -e

# Get the fingerprint of the TPM privacy CA that was used for credential activation
fingerprint=$(openssl x509 -in "${data}/pki/ca.pem" -fingerprint -noout -sha256 | sed 's/://g' | cut -d "=" -f2)

# Precompute the values of the RTM PCRs
printf "[\033[34;1m EXEC \033[0m] Precompute PCRs\n"
refs_tpm=$(mrtool precompute tpm \
    --mrs 0,1,2,3,4,5,6,7 \
    --ovmf "${images}/OVMF.fd" \
    --bootloader "${artifacts}/shimx64.efi" \
    --bootloader "${artifacts}/grubx64.efi" \
    --config "${vm_config}/mrtool.json" \
    --acpirsdp "${vm_config}/etc-acpi-rsdp" \
    --acpitables "${vm_config}/etc-acpi-tables" \
    --tableloader "${vm_config}/etc-table-loader" \
    --tpmlog "${vm_config}/etc-tpm-log" \
    --sbatlevel "${artifacts}/efivars/SbatLevelRT-605dab50-e046-4300-abb6-3dd810dd8b23" \
    --gpt "${artifacts}/ev_efi_gpt_event" \
)

# Load manifest template
json=$(cat "${input}/manifest.json")

name="de.test.rtm"

# Insert manifest properties
setjson "json" "name"                  "${name}"
setjson "json" "version"               "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
setjson "json" "developerCommonName"   "test developer"
setjson "json" "validity.notBefore"    "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "-1 day")"
setjson "json" "validity.notAfter"     "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "+2 years")"
setjson "json" "description"           "RTM Manifest"
setarr  "json" "baseLayers"            "${name}"
setjson "json" "certLevel"             3
setjson "json" "caFingerprint"         "${fingerprint}"

# Insert platform details
json=$(echo "${json}" | jq ".details.firmware = \"${firmware}\"")
json=$(echo "${json}" | jq ".details.bootloader = \"${bootloader}\"")

# Replace existing reference values with new reference values in the RTM Manifest
json=$(echo "${json}" | jq 'del(.referenceValues[])')
json=$(echo "${json}" | jq --argjson ver "${refs_tpm}" '.referenceValues += $ver')

# Save the RTM manifest
echo "Writing ${out}/rtm.manifest.json"
printf "%s\n" "${json}" > "${out}/rtm.manifest.json"

# RTM Manifest Description: Create corresponding RTM manifest description
rtmdesc=$(cat "${input}/manifest.description.json")
rtmdesc=$(echo "${rtmdesc}" | jq ".name = \"${name}.description\"")
rtmdesc=$(echo "${rtmdesc}" | jq ".manifest = \"${name}\"")

# Image Description: Add/replace RTM manifest description to/in image description
image_description=$(cat "${image_description}")
exists=$(echo "${image_description}" | jq "any(.descriptions[]; .name == \"${name}.description\")")
if [[ "${exists}" = false ]]; then
  echo "Adding RTM manifest description to image description"
else
  echo "Replacing existing RTM Manifest description"
  image_description=$(echo "$image_description" | jq ".descriptions |= map(select(.name != \"${name}.description\"))")
fi
image_description=$(echo "${image_description}" | jq --argjson desc "[${rtmdesc}]" '.descriptions += $desc')

# Image Description: Store
echo "Writing ${image_description}"
printf "%s\n" "${image_description}" > "${image_description}"
