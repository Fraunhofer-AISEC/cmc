#!/bin/bash

set -euo pipefail

trap '[ $? -eq 0 ] && exit 0; printf "%s failed\n" "$0"' EXIT
dir="$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)"

cd "${dir}"

[[ $# -lt 2 ]] || {
    echo "Usage: $(basename $0) <parse|precompute>"
    exit 1
}

mode="${1:-parse}"

if [[ "${mode}" == "parse" ]]; then
    echo "Parsing metadata..."
  generate-metadata-vm
elif [[ "${mode}" == "precompute" ]]; then
    echo "Precomputing metadata..."
  precompute-metadata-vm
else
  echo "Unknown mode ${mode}"
  exit 1
fi

sign-metadata json

cp "${dir}/data/metadata-signed/"* "${dir}/example-setup/vm-config/vm-metadata/"
cp "${dir}/data/pki/ca.pem" "${dir}/example-setup/vm-config/metadata-ca.pem"

# Delete cmc internal data to enforce new certificate generation
vm-ssh rm -r /var/cmc

# Restarting cmcd is required for fetching the updated metadata
vm-ssh systemctl restart cmcd
