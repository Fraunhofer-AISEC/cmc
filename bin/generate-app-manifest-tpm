#!/bin/bash

set -euo pipefail

trap '[ $? -eq 0 ] && exit 0; printf "%s failed\n" "$0"' EXIT
dir="$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)"
source "${dir}/bin/utils.sh"

# If ssh is not specified, the reference values are parsed from the local machine. If SSH is
# specified, the reference values are parsed from the remote, where the mrtool must be installed
if [[ $# -eq 0 ]]; then
  mrtool=(sudo "${dir}/tools/mrtool/mrtool")
elif [[ $# -eq 1 ]]; then
  mrtool=("$1" mrtool)
elif [[ $# -eq 2 ]]; then
  mrtool=("$1" "$2" mrtool)
else
  echo "Usage: $(basename $0) [ssh]"
  exit 1
fi

data="${dir}/data"
input="${dir}/example-setup/metadata-templates"
out="${data}/metadata-raw"

name="de.test.host-apps"
image_description_path="${out}/image.description.json"

if [[ ! -d "${data}" ]]; then
  echo "Data directory ${data} does not exist. Did you run the setup-cmc script? Abort.."
  exit 1
fi

if [[ ! -f "${image_description_path}" ]]; then
    echo "Error: image description ${image_description_path} does not exist. Run generate-image-description first"
    exit 1
fi

echo "Using ${data} as directory for local data"

# Parse the IMA measurement lists
referenceValues=$("${mrtool[@]}" parse ima --mrs 10)

# App Manifest: load
json=$(cat "${input}/manifest.json")

# App Manifest: Insert reference values
json=$(jq -n --argjson base "$json" --slurpfile ver <(printf '%s' "$referenceValues") '$base | .referenceValues += $ver[0]')


# App Manifest: Set other properties
setjson "json" "name"                  "${name}"
setjson "json" "version"               "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
setjson "json" "developerCommonName"   "test developer"
setjson "json" "validity.notBefore"    "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "-1 day")"
setjson "json" "validity.notAfter"     "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "+2 years")"
setjson "json" "description"           "App Manifest"
setarr  "json" "baseLayers"            "de.test.os"
setjson "json" "certLevel"             1

# App Manifest: Store
echo "Writing ${out}/app.manifest.json"
printf "%s\n" "${json}" > "${out}/app.manifest.json"

# App Description: Create corresponding app description
appdesc=$(cat "${input}/manifest.description.json")
appdesc=$(echo "${appdesc}" | jq ".name = \"${name}.description\"")
appdesc=$(echo "${appdesc}" | jq ".manifest = \"${name}\"")

# Image Description: Add/replace app description to/in image description
image_description=$(cat "${image_description_path}")
exists=$(echo "${image_description}" | jq "any(.descriptions[]; .name == \"${name}.description\")")
if [[ "${exists}" = false ]]; then
  echo "Adding app description to image description"
else
  echo "Replacing existing app description"
  image_description=$(echo "$image_description" | jq ".descriptions |= map(select(.name != \"${name}.description\"))")
fi
image_description=$(echo "${image_description}" | jq --argjson desc "[${appdesc}]" '.descriptions += $desc')

# Image Description: Store
echo "Writing ${image_description_path}"
printf "%s\n" "${image_description}" > "${image_description_path}"
