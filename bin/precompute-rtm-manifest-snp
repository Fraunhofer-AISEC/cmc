#!/bin/bash

set -euo pipefail

trap '[ $? -eq 0 ] && exit 0; printf "%s failed\n" "$0"' EXIT
dir="$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)"
source "${dir}/bin/utils.sh"

# Default values
ovmf="${dir}/vm/images/OVMF-AWS.fd"
vcpus=2
vmm_type=ec2

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --vcpus)
      vcpus="$2"
      shift 2
      ;;
    --vmm-type)
      vmm_type="$2"
      shift 2
      ;;
    --ovmf)
      ovmf="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 [--vcpus #] [--vmm-type TYPE] [--ovmf PATH]"
      exit 1
      ;;
  esac
done

data="${dir}/data"
input="${dir}/example-setup/metadata-templates"
out="${data}/metadata-raw"
pki="${data}/pki"

device_description="${out}/device.description.json"

if [[ ! -d "${data}" ]]; then
  echo "Data directory ${data} does not exist. Did you run the setup-cmc script? Abort.."
  exit 1
fi

if [[ ! -d "${input}" ]]; then
  echo "Data directory ${input} does not exist. Did you run the setup-cmc script? Abort.."
  exit 1
fi

mkdir -p "${out}"

echo "Using ${data} as directory for local data"

# Load manifest template
manifest=$(cat "${input}/manifest.json")

# Retrieve high level details
set +e
firmware="unknown"
bootloader=$(grub-install --version)
kernel=$(uname -r)
os=$(lsb_release -sd 2>/dev/null)
set -e

# Get AMD cert chains
snp_code_names=("Milan" "Genoa" "Turin")
snp_ark_names=("ark_milan.pem" "ark_genoa.pem" "ark_turin.pem")

for i in "${!snp_code_names[@]}"; do
    code="${snp_code_names[$i]}"
    ark="${snp_ark_names[$i]}"
    ark_file="${pki}/${ark}"

    if [[ ! -f "${ark_file}" ]]; then
      echo "Fetching AMD SEV-SNP ${code} CA..."
      wget -qO "${pki}/Cert_Chain_${code}" "https://kdsintf.amd.com/vlek/v1/${code}/cert_chain"
      awk '/-----BEGIN CERTIFICATE-----/{n++} n==2' "${pki}/Cert_Chain_${code}" > "${ark_file}"
    fi
    fingerprint=$(openssl x509 -in "${ark_file}" -fingerprint -noout -sha256 | sed 's/://g' | cut -d "=" -f2)
    extendarr "manifest" "caFingerprints" "${fingerprint}"
done

set +e
ref=$(calculate-snp-mr \
  --vcpus "${vcpus}" \
  --vmm-type "${vmm_type}" \
  --ovmf "${ovmf}" \
)
if [[ -z "${ref}" ]]; then
    echo "calculate-snp-mr failed: empty reference values"
    exit 1
fi
echo "${ref}" | jq empty 2>/dev/null || {
    echo "calculate-snp-mr failed: '${ref}'"
    exit 1
}
set -e



name="de.test.rtm"

# Insert manifest properties
setjson "manifest" "name"                  "${name}"
setjson "manifest" "version"               "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
setjson "manifest" "developerCommonName"   "test developer"
setjson "manifest" "validity.notBefore"    "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "-1 day")"
setjson "manifest" "validity.notAfter"     "$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "+2 years")"
setjson "manifest" "description"           "RTM Manifest"
setarr  "manifest" "baseLayers"            "${name}"
setjson "manifest" "certLevel"             3
setarr  "manifest" "referenceValues"       "${ref}"

# Insert platform details
setjson "manifest" "details.firmware" "${firmware}"
setjson "manifest" "details.bootloader" "${bootloader}"
setjson "manifest" "details.kernel" "${kernel}"
setjson "manifest" "details.os" "${os}"

policy=$(cat "${input}/snp.policy.json")

# Create policy
setjson "policy" "reportMinVersion" 2
setjson "policy" "reportMaxVersion" 5
setjson "policy" "policy.SingleSocket" false
setjson "policy" "policy.Debug" false
setjson "policy" "policy.Migration" false
setjson "policy" "policy.Smt" true
setjson "policy" "policy.AbiMajor" 0
setjson "policy" "policy.AbiMinor" 0

# Minimum TCB versions for milan processors
milan=$(cat "${input}/snp.version.json")
setjson "milan" "name" "milan"
setjson "milan" "fw.major" 1
setjson "milan" "fw.minor" 55
setjson "milan" "fw.build" 17
setjson "milan" "tcb.bl" 4
setjson "milan" "tcb.tee" 0
setjson "milan" "tcb.snp" 21
setjson "milan" "tcb.ucode" 211
extendarr "policy" "versions" "${milan}"

# Minimum TCB versions for genoa processors
genoa=$(cat "${input}/snp.version.json")
setjson "genoa" "name" "genoa"
setjson "genoa" "fw.major" 1
setjson "genoa" "fw.minor" 55
setjson "genoa" "fw.build" 39
setjson "genoa" "tcb.bl" 8
setjson "genoa" "tcb.tee" 0
setjson "genoa" "tcb.snp" 23
setjson "genoa" "tcb.ucode" 21
extendarr "policy" "versions" "${genoa}"

# Minimum TCB versions for turin processors
turin=$(cat "${input}/snp.version.json")
setjson "turin" "name" "turin"
setjson "turin" "fw.major" 1
setjson "turin" "fw.minor" 55
setjson "turin" "fw.build" 61
setjson "turin" "tcb.fmc" 0
setjson "turin" "tcb.bl" 1
setjson "turin" "tcb.tee" 0
setjson "turin" "tcb.snp" 2
setjson "turin" "tcb.ucode" 71
extendarr "policy" "versions" "${turin}"

setjson "manifest" "snpPolicy" "${policy}"

# Save the RTM manifest
printf "Writing %s\n" "${out}/rtm.manifest.json"
printf "%s\n" "${manifest}" > "${out}/rtm.manifest.json"

# Root manifest description: Create corresponding root manifest description
rootdesc=$(cat "${input}/manifest.description.json")
rootdesc=$(echo "${rootdesc}" | jq ".name = \"${name}.description\"")
rootdesc=$(echo "${rootdesc}" | jq ".manifest = \"${name}\"")

# Device Description: Add/replace root manifest description to/in device description
devdesc=$(cat "${device_description}")
exists=$(echo "${devdesc}" | jq "any(.descriptions[]; .name == \"${name}.description\")")
if [[ "${exists}" = false ]]; then
  echo "Adding root manifest description to device description"
else
  echo "Replacing existing root manifest description"
  devdesc=$(echo "$devdesc" | jq ".descriptions |= map(select(.name != \"${name}.description\"))")
fi
devdesc=$(echo "${devdesc}" | jq --argjson desc "[${rootdesc}]" '.descriptions += $desc')

# Device Description: Store
echo "Writing ${device_description}"
printf "%s\n" "${devdesc}" > "${device_description}"